<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Nayef Ahmad" />

<meta name="date" content="2019-05-16" />

<title>LGH Daily ED visits forecast</title>

<script src="02_ed-visits-forecasting_files/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="02_ed-visits-forecasting_files/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="02_ed-visits-forecasting_files/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="02_ed-visits-forecasting_files/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="02_ed-visits-forecasting_files/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="02_ed-visits-forecasting_files/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="02_ed-visits-forecasting_files/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="02_ed-visits-forecasting_files/tocify-1.9.1/jquery.tocify.js"></script>
<script src="02_ed-visits-forecasting_files/navigation-1.1/tabsets.js"></script>
<script src="02_ed-visits-forecasting_files/navigation-1.1/codefolding.js"></script>
<link href="02_ed-visits-forecasting_files/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="02_ed-visits-forecasting_files/highlightjs-9.12.0/highlight.js"></script>
<script src="02_ed-visits-forecasting_files/kePrint-0.0.1/kePrint.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>



<div class="container-fluid main-container">

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>



<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3,h4",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = false;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}

.tocify-subheader {
  display: inline;
}
.tocify-subheader .tocify-item {
  font-size: 0.95em;
}

</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="fluid-row" id="header">

<div class="btn-group pull-right">
<button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">LGH Daily ED visits forecast</h1>
<h4 class="author"><em>Nayef Ahmad</em></h4>
<h4 class="date"><em>May 16, 2019</em></h4>

</div>


<div id="setup-connection-to-database" class="section level1">
<h1>Setup connection to database:</h1>
<pre class="r"><code># Setup connections to denodo and import functions

source(here(&quot;src&quot;, 
            &quot;setup-denodo_function.R&quot;))

setup_denodo()


# Functions to pull ED data, and to forecast future ED visits:
source(here(&quot;src&quot;, 
            &quot;ed-visits-denodo_function.R&quot;))
source(here(&quot;src&quot;, 
            &quot;ed-visits-forecast-denodo_function.R&quot;))</code></pre>
<p>     </p>
</div>
<div id="set-forecast-dates" class="section level1">
<h1>Set forecast dates:</h1>
<pre class="r"><code>startdate_id &lt;- &quot;20190401&quot;
enddate_id &lt;- &quot;20190430&quot; 

data.frame(parameter = c(&quot;Beginning of fcast interval&quot;, 
                         &quot;End of fcast interval&quot;), 
           date = c(startdate_id, 
                    enddate_id)) %&gt;% 
      
      kable() %&gt;% 
      kable_styling(bootstrap_options = c(&quot;striped&quot;,
                                          &quot;condensed&quot;, 
                                          &quot;responsive&quot;))</code></pre>
<table class="table table-striped table-condensed table-responsive" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
parameter
</th>
<th style="text-align:left;">
date
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Beginning of fcast interval
</td>
<td style="text-align:left;">
20190401
</td>
</tr>
<tr>
<td style="text-align:left;">
End of fcast interval
</td>
<td style="text-align:left;">
20190430
</td>
</tr>
</tbody>
</table>
<p>     </p>
</div>
<div id="components-of-the-model" class="section level1">
<h1>Components of the model:</h1>
<pre class="r"><code>edvisits_fcast &lt;- edvisits_forecast(startdate_id,
                                    enddate_id,
                                    trend_flexibility = 0.05,
                                    save_plots = TRUE,
                                    holidays_df = holidays)</code></pre>
<p><img src="02_ed-visits-forecasting_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<pre class="r"><code>edvisits_actual &lt;- extract_ed_visits(startdate_id,
                                     enddate_id)</code></pre>
<p>     </p>
</div>
<div id="historical-data-and-fitted-model" class="section level1">
<h1>Historical data and fitted model:</h1>
<pre class="r"><code>edvisits_fcast[[2]]</code></pre>
<p><img src="02_ed-visits-forecasting_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<p>     </p>
</div>
<div id="run-forecast" class="section level1">
<h1>Run forecast:</h1>
<pre class="r"><code>edvisits_fcast[[1]] %&gt;% 
      kable() %&gt;% 
      kable_styling(bootstrap_options = c(&quot;striped&quot;,
                                          &quot;condensed&quot;, 
                                          &quot;responsive&quot;)) %&gt;% 
      scroll_box(width = &quot;100%&quot;, height = &quot;400px&quot;)</code></pre>
<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:400px; overflow-x: scroll; width:100%; ">
<table class="table table-striped table-condensed table-responsive" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:right;">
date_id
</th>
<th style="text-align:left;">
ds
</th>
<th style="text-align:right;">
edvisits_lower_ci
</th>
<th style="text-align:right;">
edvisits_fcast
</th>
<th style="text-align:right;">
edvisits_upper_ci
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
20190401
</td>
<td style="text-align:left;">
2019-04-01
</td>
<td style="text-align:right;">
177.5386
</td>
<td style="text-align:right;">
193.9855
</td>
<td style="text-align:right;">
210.9905
</td>
</tr>
<tr>
<td style="text-align:right;">
20190402
</td>
<td style="text-align:left;">
2019-04-02
</td>
<td style="text-align:right;">
165.0536
</td>
<td style="text-align:right;">
182.9672
</td>
<td style="text-align:right;">
199.7670
</td>
</tr>
<tr>
<td style="text-align:right;">
20190403
</td>
<td style="text-align:left;">
2019-04-03
</td>
<td style="text-align:right;">
165.0766
</td>
<td style="text-align:right;">
181.1656
</td>
<td style="text-align:right;">
197.8025
</td>
</tr>
<tr>
<td style="text-align:right;">
20190404
</td>
<td style="text-align:left;">
2019-04-04
</td>
<td style="text-align:right;">
166.2770
</td>
<td style="text-align:right;">
182.1948
</td>
<td style="text-align:right;">
199.5479
</td>
</tr>
<tr>
<td style="text-align:right;">
20190405
</td>
<td style="text-align:left;">
2019-04-05
</td>
<td style="text-align:right;">
169.1928
</td>
<td style="text-align:right;">
186.0803
</td>
<td style="text-align:right;">
202.2142
</td>
</tr>
<tr>
<td style="text-align:right;">
20190406
</td>
<td style="text-align:left;">
2019-04-06
</td>
<td style="text-align:right;">
168.3669
</td>
<td style="text-align:right;">
185.5131
</td>
<td style="text-align:right;">
202.9354
</td>
</tr>
<tr>
<td style="text-align:right;">
20190407
</td>
<td style="text-align:left;">
2019-04-07
</td>
<td style="text-align:right;">
178.0343
</td>
<td style="text-align:right;">
195.7800
</td>
<td style="text-align:right;">
212.9857
</td>
</tr>
<tr>
<td style="text-align:right;">
20190408
</td>
<td style="text-align:left;">
2019-04-08
</td>
<td style="text-align:right;">
176.6073
</td>
<td style="text-align:right;">
193.9665
</td>
<td style="text-align:right;">
210.6825
</td>
</tr>
<tr>
<td style="text-align:right;">
20190409
</td>
<td style="text-align:left;">
2019-04-09
</td>
<td style="text-align:right;">
166.1559
</td>
<td style="text-align:right;">
182.8392
</td>
<td style="text-align:right;">
198.9951
</td>
</tr>
<tr>
<td style="text-align:right;">
20190410
</td>
<td style="text-align:left;">
2019-04-10
</td>
<td style="text-align:right;">
164.9497
</td>
<td style="text-align:right;">
180.9275
</td>
<td style="text-align:right;">
197.3023
</td>
</tr>
<tr>
<td style="text-align:right;">
20190411
</td>
<td style="text-align:left;">
2019-04-11
</td>
<td style="text-align:right;">
165.1386
</td>
<td style="text-align:right;">
181.8498
</td>
<td style="text-align:right;">
199.0717
</td>
</tr>
<tr>
<td style="text-align:right;">
20190412
</td>
<td style="text-align:left;">
2019-04-12
</td>
<td style="text-align:right;">
169.5829
</td>
<td style="text-align:right;">
185.6360
</td>
<td style="text-align:right;">
201.5218
</td>
</tr>
<tr>
<td style="text-align:right;">
20190413
</td>
<td style="text-align:left;">
2019-04-13
</td>
<td style="text-align:right;">
168.2886
</td>
<td style="text-align:right;">
184.9814
</td>
<td style="text-align:right;">
201.3627
</td>
</tr>
<tr>
<td style="text-align:right;">
20190414
</td>
<td style="text-align:left;">
2019-04-14
</td>
<td style="text-align:right;">
177.9285
</td>
<td style="text-align:right;">
195.1768
</td>
<td style="text-align:right;">
212.5083
</td>
</tr>
<tr>
<td style="text-align:right;">
20190415
</td>
<td style="text-align:left;">
2019-04-15
</td>
<td style="text-align:right;">
176.3581
</td>
<td style="text-align:right;">
193.3113
</td>
<td style="text-align:right;">
209.0464
</td>
</tr>
<tr>
<td style="text-align:right;">
20190416
</td>
<td style="text-align:left;">
2019-04-16
</td>
<td style="text-align:right;">
165.3067
</td>
<td style="text-align:right;">
182.1548
</td>
<td style="text-align:right;">
198.8501
</td>
</tr>
<tr>
<td style="text-align:right;">
20190417
</td>
<td style="text-align:left;">
2019-04-17
</td>
<td style="text-align:right;">
162.2435
</td>
<td style="text-align:right;">
180.2391
</td>
<td style="text-align:right;">
196.7404
</td>
</tr>
<tr>
<td style="text-align:right;">
20190418
</td>
<td style="text-align:left;">
2019-04-18
</td>
<td style="text-align:right;">
165.1328
</td>
<td style="text-align:right;">
181.1847
</td>
<td style="text-align:right;">
198.3273
</td>
</tr>
<tr>
<td style="text-align:right;">
20190419
</td>
<td style="text-align:left;">
2019-04-19
</td>
<td style="text-align:right;">
167.2772
</td>
<td style="text-align:right;">
185.0229
</td>
<td style="text-align:right;">
202.5741
</td>
</tr>
<tr>
<td style="text-align:right;">
20190420
</td>
<td style="text-align:left;">
2019-04-20
</td>
<td style="text-align:right;">
168.5798
</td>
<td style="text-align:right;">
184.4494
</td>
<td style="text-align:right;">
200.0991
</td>
</tr>
<tr>
<td style="text-align:right;">
20190421
</td>
<td style="text-align:left;">
2019-04-21
</td>
<td style="text-align:right;">
178.9102
</td>
<td style="text-align:right;">
194.7548
</td>
<td style="text-align:right;">
211.1059
</td>
</tr>
<tr>
<td style="text-align:right;">
20190422
</td>
<td style="text-align:left;">
2019-04-22
</td>
<td style="text-align:right;">
176.2857
</td>
<td style="text-align:right;">
193.0272
</td>
<td style="text-align:right;">
208.3007
</td>
</tr>
<tr>
<td style="text-align:right;">
20190423
</td>
<td style="text-align:left;">
2019-04-23
</td>
<td style="text-align:right;">
165.3301
</td>
<td style="text-align:right;">
182.0349
</td>
<td style="text-align:right;">
198.1997
</td>
</tr>
<tr>
<td style="text-align:right;">
20190424
</td>
<td style="text-align:left;">
2019-04-24
</td>
<td style="text-align:right;">
164.0393
</td>
<td style="text-align:right;">
180.3071
</td>
<td style="text-align:right;">
198.1763
</td>
</tr>
<tr>
<td style="text-align:right;">
20190425
</td>
<td style="text-align:left;">
2019-04-25
</td>
<td style="text-align:right;">
164.0233
</td>
<td style="text-align:right;">
181.4612
</td>
<td style="text-align:right;">
198.7455
</td>
</tr>
<tr>
<td style="text-align:right;">
20190426
</td>
<td style="text-align:left;">
2019-04-26
</td>
<td style="text-align:right;">
169.1242
</td>
<td style="text-align:right;">
185.5248
</td>
<td style="text-align:right;">
200.7089
</td>
</tr>
<tr>
<td style="text-align:right;">
20190427
</td>
<td style="text-align:left;">
2019-04-27
</td>
<td style="text-align:right;">
167.9524
</td>
<td style="text-align:right;">
185.1895
</td>
<td style="text-align:right;">
202.5511
</td>
</tr>
<tr>
<td style="text-align:right;">
20190428
</td>
<td style="text-align:left;">
2019-04-28
</td>
<td style="text-align:right;">
180.2654
</td>
<td style="text-align:right;">
195.7411
</td>
<td style="text-align:right;">
213.0263
</td>
</tr>
<tr>
<td style="text-align:right;">
20190429
</td>
<td style="text-align:left;">
2019-04-29
</td>
<td style="text-align:right;">
177.9431
</td>
<td style="text-align:right;">
194.2629
</td>
<td style="text-align:right;">
211.5426
</td>
</tr>
<tr>
<td style="text-align:right;">
20190430
</td>
<td style="text-align:left;">
2019-04-30
</td>
<td style="text-align:right;">
167.6295
</td>
<td style="text-align:right;">
183.5182
</td>
<td style="text-align:right;">
200.7281
</td>
</tr>
</tbody>
</table>
</div>
<p>     </p>
</div>
<div id="validating-forecast-with-actual-data" class="section level1">
<h1>Validating forecast with actual data:</h1>
<p>Note that the cross-validated MAPE of the model for 1-week horizon forecasts is about 8%. MAE is about 15.</p>
<pre class="r"><code># plot comparing actual with forecast: 
edvisits_fcast_df &lt;- edvisits_fcast[[1]]

edvisits_fcast_df %&gt;%
      ggplot(aes(x = ds,
                 y = edvisits_fcast)) +
      geom_ribbon(aes(x = ds,
                      ymin = edvisits_lower_ci,
                      ymax = edvisits_upper_ci),
                  fill = &quot;grey80&quot;,
                  alpha = 0.5) +
      geom_line(col = &quot;skyblue&quot;) +
      geom_point(col = &quot;skyblue&quot;) +

      geom_line(data = edvisits_actual %&gt;%
                      bind_cols(edvisits_fcast_df %&gt;% select(ds)),
                aes(x = ds,
                    y = value),
                col = &quot;blue&quot;) +

      theme_light() +
      theme(panel.grid.minor = element_line(colour = &quot;grey95&quot;),
              panel.grid.major = element_line(colour = &quot;grey95&quot;))</code></pre>
<p><img src="02_ed-visits-forecasting_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
